<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî 3D Review Hub</title>
  <link rel="stylesheet" href="styles/dashboard.css" />
</head>
<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <div class="header-brand">
        <h1>3D Review Hub</h1>
        <span id="userGreeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</span>
      </div>
      <div class="header-actions">
        <button id="newProjectBtn" class="btn btn-primary">+ –ü—Ä–æ–µ–∫—Ç</button>
        <button id="newPortfolioItemBtn" class="btn btn-outline">+ –í –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</button>
        <button id="logoutBtn" class="btn btn-outline">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <main class="dashboard-main">
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <a href="#" class="nav-item active" data-tab="projects">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</a>
          <a href="#" class="nav-item" data-tab="archive">üóÑÔ∏è –ê—Ä—Ö–∏–≤</a>
          <a href="#" class="nav-item" data-tab="portfolio">üé® –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
          <a href="#" class="nav-item" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        </nav>
        <div class="user-stats">
          <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
          <div class="stat">
            <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:</span>
            <strong id="activeProjectsCount">0</strong>
          </div>
          <div class="stat">
            <span>–¢–∞—Ä–∏—Ñ:</span>
            <strong id="userPlan">Free</strong>
          </div>
        </div>
      </aside>

      <section class="content">
        <!-- –ü—Ä–æ–µ–∫—Ç—ã -->
        <div id="projects-tab" class="tab-content active">
          <div class="content-header">
            <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h2>
            <p>–ü—Ä–æ–µ–∫—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
          </div>
          <div id="projectsList" class="projects-grid"></div>
          <div id="emptyState" class="empty-state">
            <div class="empty-icon">üìÅ</div>
            <h3>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç</p>
            <button id="createFirstProject" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
          </div>
        </div>

        <!-- –ê—Ä—Ö–∏–≤ -->
        <div id="archive-tab" class="tab-content">
          <div class="content-header">
            <h2>–ê—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤</h2>
            <p>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</p>
          </div>
          <div id="archiveList" class="projects-grid"></div>
        </div>

        <!-- –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
        <div id="portfolio-tab" class="tab-content">
          <div class="content-header">
            <h2>–ú–æ—ë –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
            <p>–ü—É–±–ª–∏—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
          </div>
          <div class="portfolio-actions" style="margin-bottom:20px;">
            <button id="addPortfolioItem" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
            <a id="viewPublicPortfolio" href="" target="_blank" class="btn btn-outline" style="display:none;">–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
          </div>
          <div id="portfolioSections"></div>
          <div id="portfolioEmpty" class="empty-state" style="display:none;">
            <div class="empty-icon">üé®</div>
            <h3>–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø—É—Å—Ç–æ</h3>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—Ç—É</p>
          </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="settings-tab" class="tab-content">
          <div class="content-header">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
          </div>
          <div class="settings-content">
            <div class="setting-group">
              <h4>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω</h4>
              <div class="plan-info">
                <div class="current-plan">
                  <strong>–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω: <span id="currentPlan">Free</span></strong>
                </div>
                <button class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ Pro</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ: –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="projectForm" class="modal-form" enctype="multipart/form-data">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" name="name" required />
        </div>
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea name="description"></textarea>
        </div>
        <div class="form-group">
          <label>3D –ú–æ–¥–µ–ª—å *</label>
          <div class="file-upload">
            <input type="file" name="model" accept=".stl,.glb,.obj" required />
            <label class="file-upload-label">üìÅ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
          </div>
          <div class="file-info" id="projectFileInfo"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>–°—Ä–æ–∫ (—á–∞—Å—ã)</label>
            <select name="expiresIn">
              <option value="24">24 —á</option>
              <option value="72">3 –¥–Ω—è</option>
              <option value="168">7 –¥–Ω–µ–π</option>
              <option value="720">30 –¥–Ω–µ–π</option>
            </select>
          </div>
          <div class="form-group">
            <label>–†–µ–∂–∏–º</label>
            <select name="mode">
              <option value="individual">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
              <option value="collaborative">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>–ü–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input type="password" name="password" />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline modal-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ: –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
  <div id="portfolioModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–ù–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="portfolioForm" class="modal-form" enctype="multipart/form-data">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" name="title" required />
        </div>
        <div class="form-group">
          <label>–†–∞–∑–¥–µ–ª *</label>
          <input type="text" name="section" placeholder="–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ü–µ—Ä—Å–æ–Ω–∞–∂–∏..." required />
        </div>
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea name="description"></textarea>
        </div>
        <div class="form-group">
          <label>–§–æ—Ç–æ –ø—Ä–µ–≤—å—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <div class="file-upload">
            <input type="file" name="preview" accept="image/*" />
            <label class="file-upload-label">üñºÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
          </div>
        </div>
        <div class="form-group">
          <label>–í–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <div class="file-upload">
            <input type="file" name="video" accept="video/*" />
            <label class="file-upload-label">üé• –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ</label>
          </div>
        </div>
        <div class="form-group">
          <label>3D –ú–æ–¥–µ–ª—å GLB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <div class="file-upload">
            <input type="file" name="model" accept=".glb" />
            <label class="file-upload-label">üî∑ –í—ã–±–µ—Ä–∏—Ç–µ GLB</label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline modal-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let userId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadUserData();
      await loadProjects();
      await loadPortfolio();
      setupEventListeners();
    });

    async function loadUserData() {
      const res = await fetch('/api/projects');
      const projects = await res.json();
      if (projects.length > 0) {
        userId = projects[0].userId;
        document.getElementById('viewPublicPortfolio').href = `/portfolio/${userId}`;
        document.getElementById('viewPublicPortfolio').style.display = 'inline-block';
      }
    }

    async function loadProjects() {
      const res = await fetch('/api/projects');
      const projects = await res.json();
      displayProjects(projects);
      document.getElementById('activeProjectsCount').textContent = 
        projects.filter(p => p.status === 'active').length;
    }

    function displayProjects(projects) {
      const active = projects.filter(p => p.status === 'active');
      const archived = projects.filter(p => p.status !== 'active');

      const list = document.getElementById('projectsList');
      const archiveList = document.getElementById('archiveList');
      const empty = document.getElementById('emptyState');

      if (active.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        list.innerHTML = active.map(p => `
          <div class="project-card">
            <div class="project-header">
              <h3>${p.name}</h3>
              <span class="project-status ${p.status}">${p.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : ''}</span>
            </div>
            <div class="project-info">
              <p>${p.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
              <div class="project-meta">
                <span>–°–æ–∑–¥–∞–Ω: ${new Date(p.createdAt).toLocaleDateString()}</span>
                <span>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(p.expiresAt).toLocaleDateString()}</span>
              </div>
            </div>
            <div class="project-actions">
              <button class="btn btn-outline btn-small copy-link" data-url="${p.fullShareUrl}">–°—Å—ã–ª–∫–∞</button>
              <button class="btn btn-outline btn-small open-viewer" data-id="${p.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn btn-outline btn-small archive-project" data-id="${p.id}">–ê—Ä—Ö–∏–≤</button>
            </div>
          </div>
        `).join('');
      }

      archiveList.innerHTML = archived.map(p => `
        <div class="project-card archived">
          <div class="project-header">
            <h3>${p.name}</h3>
            <span class="project-status archived">${p.status === 'archived' ? '–ê—Ä—Ö–∏–≤' : '–ò—Å—Ç—ë–∫'}</span>
          </div>
          <div class="project-info">
            <p>${p.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
            <div class="project-meta">
              <span>–°–æ–∑–¥–∞–Ω: ${new Date(p.createdAt).toLocaleDateString()}</span>
              <span>–ó–∞–≤–µ—Ä—à—ë–Ω: ${new Date(p.expiresAt).toLocaleDateString()}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function loadPortfolio() {
      const res = await fetch('/api/portfolio-items');
      const { items } = await res.json();
      displayPortfolio(items);
    }

    function displayPortfolio(items) {
      const container = document.getElementById('portfolioSections');
      const empty = document.getElementById('portfolioEmpty');

      if (items.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      const sections = [...new Set(items.map(i => i.section || '–û—Å–Ω–æ–≤–Ω–æ–µ'))].sort();
      let html = '';
      sections.forEach(section => {
        const sectionItems = items.filter(i => (i.section || '–û—Å–Ω–æ–≤–Ω–æ–µ') === section);
        html += `<h3 style="margin:20px 0 10px;">${section}</h3>`;
        html += `<div class="projects-grid">`;
        html += sectionItems.map(i => `
          <div class="project-card">
            <div class="project-header">
              <h3>${i.title}</h3>
              <button class="btn btn-outline btn-small delete-portfolio" data-id="${i.id}">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="project-info">
              <p>${i.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
              <div class="project-meta">
                <span>–î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(i.createdAt).toLocaleDateString()}</span>
              </div>
            </div>
            <div class="project-actions">
              <a href="/portfolio/${userId}/project/${i.id}" target="_blank" class="btn btn-outline btn-small">–û—Ç–∫—Ä—ã—Ç—å</a>
              <button class="btn btn-outline btn-small copy-portfolio-link" data-url="/portfolio/${userId}/project/${i.id}">–°—Å—ã–ª–∫–∞</button>
            </div>
          </div>
        `).join('');
        html += `</div>`;
      });
      container.innerHTML = html;
    }

    function setupEventListeners() {
      // –í–∫–ª–∞–¥–∫–∏
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', e => {
          e.preventDefault();
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          item.classList.add('active');
          document.getElementById(`${item.dataset.tab}-tab`).classList.add('active');
        });
      });

      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫
      document.getElementById('newProjectBtn').addEventListener('click', () => document.getElementById('projectModal').style.display = 'flex');
      document.getElementById('createFirstProject').addEventListener('click', () => document.getElementById('projectModal').style.display = 'flex');
      document.getElementById('newPortfolioItemBtn').addEventListener('click', () => document.getElementById('portfolioModal').style.display = 'flex');
      document.getElementById('addPortfolioItem').addEventListener('click', () => document.getElementById('portfolioModal').style.display = 'flex');

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫
      ['projectModal', 'portfolioModal'].forEach(id => {
        const el = document.getElementById(id);
        el.querySelector('.modal-close')?.addEventListener('click', () => el.style.display = 'none');
        el.querySelector('.modal-cancel')?.addEventListener('click', () => el.style.display = 'none');
        el.addEventListener('click', e => { if (e.target === el) el.style.display = 'none'; });
      });

      // –ò–Ω—Ñ–æ –æ —Ñ–∞–π–ª–µ
      document.querySelector('[name="model"]')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const info = document.getElementById('projectFileInfo');
        info.innerHTML = file ? `<strong>${file.name}</strong> (${(file.size/1048576).toFixed(2)} MB)` : '';
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      document.getElementById('projectForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
        const formData = new FormData(e.target);
        try {
          const res = await fetch('/api/projects', { method: 'POST', body: formData });
          const r = await res.json();
          if (r.success) {
            document.getElementById('projectModal').style.display = 'none';
            e.target.reset();
            document.getElementById('projectFileInfo').innerHTML = '';
            await loadProjects();
            alert(`‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!\n–°—Å—ã–ª–∫–∞:\n${r.project.shareUrl}`);
          } else {
            alert('‚ùå ' + r.error);
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = '–°–æ–∑–¥–∞—Ç—å';
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
      document.getElementById('portfolioForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
        const formData = new FormData(e.target);
        try {
          const res = await fetch('/api/portfolio-items', { method: 'POST', body: formData });
          const r = await res.json();
          if (r.success) {
            document.getElementById('portfolioModal').style.display = 'none';
            e.target.reset();
            await loadPortfolio();
            alert('‚úÖ –†–∞–±–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ!');
          } else {
            alert('‚ùå ' + r.error);
          }
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
        }
      });

      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      document.addEventListener('click', async e => {
        if (e.target.classList.contains('copy-link') || e.target.classList.contains('copy-portfolio-link')) {
          await navigator.clipboard.writeText(e.target.dataset.url);
          alert('üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        } else if (e.target.classList.contains('open-viewer')) {
          window.open(`/view/${e.target.dataset.id}`, '_blank');
        } else if (e.target.classList.contains('archive-project')) {
          if (confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç?')) {
            await fetch(`/api/projects/${e.target.dataset.id}/archive`, { method: 'POST' });
            await loadProjects();
          }
        } else if (e.target.classList.contains('delete-portfolio')) {
          if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ?')) {
            await fetch(`/api/portfolio-items/${e.target.dataset.id}`, { method: 'DELETE' });
            await loadPortfolio();
          }
        }
      });

      // –í—ã—Ö–æ–¥
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/';
      });
    }
  </script>
</body>
</html>