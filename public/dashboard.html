<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - 3D Review Hub</title>
    <link rel="stylesheet" href="styles/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="dashboard-header">
            <div class="header-brand">
                <h1>3D Review Hub</h1>
                <span id="userGreeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</span>
            </div>
            <div class="header-actions">
                <button id="newProjectBtn" class="btn btn-primary">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
                <button id="logoutBtn" class="btn btn-outline">–í—ã–π—Ç–∏</button>
            </div>
        </header>
        <main class="dashboard-main">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item active" data-tab="projects">üìÅ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</a>
                    <a href="#" class="nav-item" data-tab="archive">üóÑÔ∏è –ê—Ä—Ö–∏–≤</a>
                    <a href="#" class="nav-item" data-tab="portfolio">üé® –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
                    <a href="#" class="nav-item" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                </nav>
                <div class="user-stats">
                    <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div class="stat">
                        <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:</span>
                        <strong id="activeProjectsCount">0</strong>
                    </div>
                    <div class="stat">
                        <span>–¢–∞—Ä–∏—Ñ:</span>
                        <strong id="userPlan">Free</strong>
                    </div>
                </div>
            </aside>
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <section class="content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
                <div id="projects-tab" class="tab-content active">
                    <div class="content-header">
                        <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h2>
                        <p>–ü—Ä–æ–µ–∫—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
                    </div>
                    <div id="projectsList" class="projects-grid"></div>
                    <div id="emptyState" class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <h3>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è 3D –º–æ–¥–µ–ª—å—é —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                        <button id="createFirstProject" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </div>
                <!-- –í–∫–ª–∞–¥–∫–∞ –∞—Ä—Ö–∏–≤–∞ -->
                <div id="archive-tab" class="tab-content">
                    <div class="content-header">
                        <h2>–ê—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤</h2>
                        <p>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</p>
                    </div>
                    <div id="archiveList" class="projects-grid"></div>
                </div>
                <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
                <div id="portfolio-tab" class="tab-content">
                    <div class="content-header">
                        <h2>–ú–æ—ë –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
                        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–∏ –ª—É—á—à–∏–µ —Ä–∞–±–æ—Ç—ã: —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, 3D-–º–æ–¥–µ–ª–∏</p>
                    </div>
                    <button id="addPortfolioBtn" class="btn btn-primary" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
                    <div id="portfolioGrid" class="projects-grid"></div>
                    <div id="portfolioEmpty" class="empty-state" style="display: none;">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <h3>–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –µ—â—ë –ø—É—Å—Ç</h3>
                        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ —Ä–∞–±–æ—Ç—ã –∏ –ø–æ–∫–∞–∂–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º —Å–≤–æ—ë –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ</p>
                    </div>
                </div>
                <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                <div id="settings-tab" class="tab-content">
                    <div class="content-header">
                        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                    </div>
                    <div class="settings-content">
                        <div class="setting-group">
                            <h4>–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω</h4>
                            <div class="plan-info">
                                <div class="current-plan">
                                    <strong>–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω: <span id="currentPlan">Free</span></strong>
                                </div>
                                <button class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å –¥–æ Pro</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="projectForm" class="modal-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="projectName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                    <input type="text" id="projectName" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ò–≤–∞–Ω–∞">
                </div>
                <div class="form-group">
                    <label for="projectDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="projectDescription" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –≤–∞—Å"></textarea>
                </div>
                <div class="form-group">
                    <label for="projectModel">3D –ú–æ–¥–µ–ª—å *</label>
                    <div class="file-upload">
                        <input type="file" id="projectModel" name="model" accept=".stl,.glb,.obj" required>
                        <label for="projectModel" class="file-upload-label">
                            <span class="file-icon">üìÅ</span>
                            <span class="file-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏</span>
                        </label>
                    </div>
                    <div class="file-info" id="fileInfo"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="projectExpires">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (—á–∞—Å—ã)</label>
                        <select id="projectExpires" name="expiresIn">
                            <option value="24">24 —á–∞—Å–∞</option>
                            <option value="72">3 –¥–Ω—è</option>
                            <option value="168">7 –¥–Ω–µ–π</option>
                            <option value="720">30 –¥–Ω–µ–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectMode">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                        <select id="projectMode" name="mode">
                            <option value="individual">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                            <option value="collaborative">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="projectPassword">–ü–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="password" id="projectPassword" name="password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
    <div id="portfolioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="portfolioForm" class="modal-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="portfolioTitle">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" id="portfolioTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="portfolioDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="portfolioDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="portfolioFile">–§–∞–π–ª (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, STL) *</label>
                    <div class="file-upload">
                        <input type="file" id="portfolioFile" name="file" accept="image/*,video/*,.stl" required>
                        <label for="portfolioFile" class="file-upload-label">
                            <span class="file-icon">üìé</span>
                            <span class="file-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
                        </label>
                    </div>
                    <div class="file-info" id="portfolioFileInfo"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProjects();
            setupEventListeners();
        });

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                displayProjects(projects);
                updateStats(projects);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            }
        }

        function displayProjects(projects) {
            const projectsList = document.getElementById('projectsList');
            const archiveList = document.getElementById('archiveList');
            const emptyState = document.getElementById('emptyState');
            const activeProjects = projects.filter(p => p.status === 'active');
            const archivedProjects = projects.filter(p => p.status !== 'active');

            if (activeProjects.length === 0) {
                projectsList.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                projectsList.innerHTML = activeProjects.map(project => `
                    <div class="project-card" data-project-id="${project.id}">
                        <div class="project-header">
                            <h3>${project.name}</h3>
                            <span class="project-status ${project.status}">${getStatusText(project.status)}</span>
                        </div>
                        <div class="project-info">
                            <p>${project.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                            <div class="project-meta">
                                <span>–°–æ–∑–¥–∞–Ω: ${new Date(project.createdAt).toLocaleDateString()}</span>
                                <span>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(project.expiresAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-outline btn-small copy-link" data-url="${project.fullShareUrl}">
                                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <button class="btn btn-outline btn-small open-viewer" data-project-id="${project.id}">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                            <button class="btn btn-outline btn-small archive-project" data-project-id="${project.id}">
                                –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            archiveList.innerHTML = archivedProjects.map(project => `
                <div class="project-card archived" data-project-id="${project.id}">
                    <div class="project-header">
                        <h3>${project.name}</h3>
                        <span class="project-status ${project.status}">${getStatusText(project.status)}</span>
                    </div>
                    <div class="project-info">
                        <p>${project.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <div class="project-meta">
                            <span>–°–æ–∑–¥–∞–Ω: ${new Date(project.createdAt).toLocaleDateString()}</span>
                            <span>–ó–∞–≤–µ—Ä—à–µ–Ω: ${new Date(project.expiresAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'active': '–ê–∫—Ç–∏–≤–µ–Ω',
                'archived': '–í –∞—Ä—Ö–∏–≤–µ',
                'expired': '–ò—Å—Ç–µ–∫'
            };
            return statusMap[status] || status;
        }

        function updateStats(projects) {
            const activeCount = projects.filter(p => p.status === 'active').length;
            document.getElementById('activeProjectsCount').textContent = activeCount;
        }

        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const items = await response.json();
                displayPortfolio(items);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ:', error);
            }
        }

        function displayPortfolio(items) {
            const grid = document.getElementById('portfolioGrid');
            const empty = document.getElementById('portfolioEmpty');
            if (items.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                grid.innerHTML = items.map(item => {
                    let preview = `<div>–§–∞–π–ª: ${item.originalName}</div>`;
                    if (item.originalName.toLowerCase().endsWith('.jpg') || 
                        item.originalName.toLowerCase().endsWith('.png') ||
                        item.originalName.toLowerCase().endsWith('.jpeg')) {
                        preview = `<img src="/portfolio-files/${item.fileName}" style="width:100%; border-radius:8px;">`;
                    }
                    return `
                        <div class="project-card">
                            <h3>${item.title}</h3>
                            <p>${item.description || '‚Äî'}</p>
                            <div style="margin:10px 0;">${preview}</div>
                            <div style="font-size:0.8em; color:#999;">${new Date(item.createdAt).toLocaleDateString()}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById(`${item.dataset.tab}-tab`).classList.add('active');
                    if (item.dataset.tab === 'portfolio') {
                        loadPortfolio();
                    }
                });
            });

            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const closeBtn = modal.querySelector('.modal-close');
                const cancelBtn = modal.querySelector('.modal-cancel');
                if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
                if (cancelBtn) cancelBtn.addEventListener('click', () => modal.style.display = 'none');
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });

            document.getElementById('newProjectBtn').addEventListener('click', () => {
                document.getElementById('projectModal').style.display = 'flex';
            });
            document.getElementById('createFirstProject').addEventListener('click', () => {
                document.getElementById('projectModal').style.display = 'flex';
            });
            document.getElementById('addPortfolioBtn').addEventListener('click', () => {
                document.getElementById('portfolioModal').style.display = 'flex';
            });

            document.getElementById('projectModel').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const fileInfo = document.getElementById('fileInfo');
                if (file) {
                    fileInfo.innerHTML = `<strong>${file.name}</strong> (${(file.size / (1024*1024)).toFixed(2)} MB)`;
                } else {
                    fileInfo.innerHTML = '';
                }
            });

            document.getElementById('portfolioFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const fileInfo = document.getElementById('portfolioFileInfo');
                if (file) {
                    fileInfo.innerHTML = `<strong>${file.name}</strong> (${(file.size / (1024*1024)).toFixed(2)} MB)`;
                } else {
                    fileInfo.innerHTML = '';
                }
            });

            document.getElementById('projectForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
                try {
                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('projectModal').style.display = 'none';
                        e.target.reset();
                        document.getElementById('fileInfo').innerHTML = '';
                        await loadProjects();
                        alert(`–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!\n–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:\n\n${result.project.shareUrl}`);
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + result.error);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç';
                }
            });

            document.getElementById('portfolioForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                try {
                    const response = await fetch('/api/portfolio', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('portfolioModal').style.display = 'none';
                        e.target.reset();
                        document.getElementById('portfolioFileInfo').innerHTML = '';
                        await loadPortfolio();
                        alert('–†–∞–±–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ!');
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + result.error);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
                }
            });

            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('copy-link')) {
                    const url = e.target.dataset.url;
                    await navigator.clipboard.writeText(url);
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('open-viewer')) {
                    const projectId = e.target.dataset.projectId;
                    window.open(`/view/${projectId}`, '_blank');
                }
            });

            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('archive-project')) {
                    const projectId = e.target.dataset.projectId;
                    if (confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç?')) {
                        try {
                            await fetch(`/api/projects/${projectId}/archive`, { method: 'POST' });
                            await loadProjects();
                        } catch (error) {
                            alert('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏');
                        }
                    }
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                    window.location.href = '/';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                }
            });
        }
    </script>
</body>
</html>